{% extends "base.html" %}

{% block title %}Dashboard Admin - Assessment App{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-shield-alt me-2"></i>Dashboard Amministratore</h1>
                <div>
                    <a href="{{ url_for('admin_download_report') }}" class="btn btn-success btn-lg">
                        <i class="fas fa-download me-2"></i>Scarica Report Completo
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtri Dinamici -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter me-2"></i>Filtri Dinamici</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">Azienda</label>
                            <select class="form-select" id="filterAzienda" onchange="applyFilters()">
                                <option value="">Tutte le Aziende</option>
                                <option value="auxiell">auxiell</option>
                                <option value="euxilia">euxilia</option>
                                <option value="xva">xva</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo Test</label>
                            <select class="form-select" id="filterTest" onchange="applyFilters()">
                                <option value="">Tutti i Test</option>
                                <!-- Opzioni dinamiche popolate via JS -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Utente Specifico</label>
                            <select class="form-select" id="filterUser" onchange="applyFilters()">
                                <option value="">Tutti gli Utenti</option>
                                <!-- Opzioni dinamiche popolate via JS -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Periodo</label>
                            <select class="form-select" id="filterPeriodo" onchange="applyFilters()">
                                <option value="">Tutto il Periodo</option>
                                <option value="30">Ultimi 30 giorni</option>
                                <option value="90">Ultimi 3 mesi</option>
                                <option value="365">Ultimo anno</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Vista</label>
                            <select class="form-select" id="filterVista" onchange="changeView()">
                                <option value="overview">Panoramica</option>
                                <option value="by-company">Per Azienda</option>
                                <option value="by-test">Per Tipo Test</option>
                                <option value="timeline">Timeline</option>
                                <option value="performance">Performance</option>
                                <option value="user-detail">Dettaglio Utente</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistiche Generali -->
    <div class="row mb-4" id="statsOverview">
        <div class="col-md-2 offset-md-1">
            <div class="card text-center h-100 border-primary bg-white">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h6 class="card-title text-dark mb-1">Utenti Totali</h6>
                    <h3 class="text-primary mb-0" id="totalUsers">{{ total_users|default(0) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center h-100 border-success bg-white">
                <div class="card-body">
                    <i class="fas fa-clipboard-check fa-2x text-success mb-2"></i>
                    <h6 class="card-title text-dark mb-1">Test Completati</h6>
                    <h3 class="text-success mb-0" id="totalTests">{{ total_tests|default(0) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center h-100 border-warning bg-white">
                <div class="card-body">
                    <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                    <h6 class="card-title text-dark mb-1">Punteggio Medio</h6>
                    <h3 class="text-warning mb-0" id="avgScore">
                        {% if average_score is defined %}
                            {{ average_score|round(1) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center h-100 border-info bg-white">
                <div class="card-body">
                    <i class="fas fa-medal fa-2x text-info mb-2"></i>
                    <h6 class="card-title text-dark mb-1">Tasso Successo</h6>
                    <h3 class="text-info mb-0" id="successRate">
                        {% if success_rate is defined %}
                            {{ success_rate|round(1) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </h3>
                    <small class="text-secondary">‚â• 60%</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center h-100 border-secondary bg-white">
                <div class="card-body">
                    <i class="fas fa-chart-bar fa-2x text-secondary mb-2"></i>
                    <h6 class="card-title text-dark mb-1">Test/Utente</h6>
                    <h3 class="text-secondary mb-0" id="testsPerUser">
                        {% if total_users and total_users > 0 %}
                            {{ (total_tests / total_users)|round(1) }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione Strumenti di Gestione (NUOVA) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Strumenti di Gestione
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="/admin/users" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <strong>Lista Utenti</strong>
                                <small class="text-muted">Gestisci tutti gli utenti</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/admin/download_report" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="fas fa-file-excel fa-2x mb-2"></i>
                                <strong>Report Completo</strong>
                                <small class="text-muted">Scarica tutti i dati</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/admin/azure-status" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3" target="_blank">
                                <i class="fas fa-cloud fa-2x mb-2"></i>
                                <strong>Status Azure</strong>
                                <small class="text-muted">Verifica connessione</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <div class="btn btn-outline-secondary w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                <strong>Analytics</strong>
                                <small class="text-muted">Prossimamente</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ricerca Utente Rapida (NUOVA) -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Cerca Utente Specifico</h6>
                            <div class="input-group">
                                <input type="email" 
                                       class="form-control" 
                                       id="searchUserEmail" 
                                       placeholder="email@azienda.com">
                                <button class="btn btn-outline-primary" 
                                        type="button" 
                                        onclick="goToUser()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <small class="text-muted">Inserisci l'email completa dell'utente</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Container Dinamico per le Viste -->
    <div id="dynamicContent">
        
        <!-- Vista Panoramica (Default) -->
        <div id="viewOverview" class="dashboard-view">
            <div class="row">
                <!-- Statistiche per Azienda -->
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-chart-pie text-primary me-2"></i>
                            Statistiche per Azienda
                        </h3>
                        <div id="companyStatsTable">
                            <!-- Popolato dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Test Recenti CON LINK UTENTI (MODIFICATO) -->
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-clock text-warning me-2"></i>
                            Test Recenti
                        </h3>
                        <div id="recentTestsList">
                            <!-- VERSIONE AGGIORNATA CON LINK -->
                            {% if recent_tests %}
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Utente</th>
                                                <th>Test</th>
                                                <th>Punteggio</th>
                                                <th>Data</th>
                                                <th>Azienda</th>
                                                <th class="text-center">Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for test in recent_tests %}
                                            <tr>
                                                <td>
                                                    <strong>{{ test.user_name }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ test.user_email }}</small>
                                                </td>
                                                <td>{{ test.test_name }}</td>
                                                <td>
                                                    <span class="badge 
                                                        {% if test.score >= 80 %}bg-success
                                                        {% elif test.score >= 60 %}bg-warning
                                                        {% else %}bg-danger
                                                        {% endif %}">
                                                        {{ test.score }}%
                                                    </span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {% if test.completed_at %}
                                                            {{ test.completed_at[:10] }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ test.azienda }}</span>
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <!-- Link per vedere tutti i test dell'utente -->
                                                        <a href="/admin/user/{{ test.user_email }}" 
                                                           class="btn btn-outline-primary"
                                                           title="Vedi tutti i test di {{ test.user_name }}">
                                                            <i class="fas fa-user"></i>
                                                        </a>
                                                        <!-- Link per scaricare questo test specifico -->
                                                        <a href="/admin/download_user_test/{{ test.user_email }}/{{ test.test_name }}" 
                                                           class="btn btn-outline-success"
                                                           title="Scarica questo test">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p class="text-muted mb-0">Nessun test recente trovato.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista Per Azienda -->
        <div id="viewBycompany" class="dashboard-view d-none">
            <div class="row">
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-building text-primary me-2"></i>
                            Analisi Dettagliata per Azienda
                        </h3>
                        <div id="companyDetailedAnalysis">
                            <!-- Grafici e tabelle dettagliate per azienda -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-chart-bar text-info me-2"></i>
                            Top Performer
                        </h3>
                        <div id="topPerformers">
                            <!-- Lista top performer -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista Per Tipo Test -->
        <div id="viewBytest" class="dashboard-view d-none">
            <div class="row">
                <div class="col-md-12">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-clipboard-list text-success me-2"></i>
                            Analisi per Tipo di Test
                        </h3>
                        <div id="testTypeAnalysis">
                            <!-- Analisi dettagliata per tipo di test -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista Timeline -->
        <div id="viewTimeline" class="dashboard-view d-none">
            <div class="row">
                <div class="col-md-12">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-chart-line text-warning me-2"></i>
                            Andamento nel Tempo
                        </h3>
                        <div style="height: 400px;">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mt-4">
                    <div class="dashboard-card">
                        <h3 class="mb-3">Tendenze Mensili</h3>
                        <div style="height: 300px;">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mt-4">
                    <div class="dashboard-card">
                        <h3 class="mb-3">Confronto Periodi</h3>
                        <div id="periodComparison">
                            <!-- Confronto tra periodi -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista Performance -->
        <div id="viewPerformance" class="dashboard-view d-none">
            <div class="row">
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-trophy text-danger me-2"></i>
                            Analisi delle Performance
                        </h3>
                        <div id="performanceAnalysis">
                            <!-- Analisi performance dettagliate -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-medal text-gold me-2"></i>
                            Ranking
                        </h3>
                        <div id="rankingList">
                            <!-- Ranking utenti/aziende -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista Dettaglio Utente -->
        <div id="viewUserdetail" class="dashboard-view d-none">
            <div class="row">
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-user-circle text-info me-2"></i>
                            Dettaglio Utente <span id="selectedUserName"></span>
                        </h3>
                        <div id="userDetailContent">
                            <!-- Dettagli specifici dell'utente -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-chart-pie text-primary me-2"></i>
                            Statistiche Utente
                        </h3>
                        <div id="userStats">
                            <!-- Statistiche utente -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="dashboard-card">
                        <h3 class="mb-3">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            Progresso nel Tempo
                        </h3>
                        <div style="height: 300px;">
                            <canvas id="userProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Azioni Admin (AGGIORNATE) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h3 class="mb-3">
                    <i class="fas fa-tools text-info me-2"></i>
                    Azioni Amministratore
                </h3>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                <h5>Report Completo</h5>
                                <p class="text-muted">Scarica Excel con tutti i test svolti</p>
                                <a href="{{ url_for('admin_download_report') }}" class="btn btn-success">
                                    <i class="fas fa-download me-1"></i>Scarica
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-database fa-3x text-primary mb-3"></i>
                                <h5>Stato Azure</h5>
                                <p class="text-muted">Verifica connessione Azure Tables</p>
                                <button class="btn btn-primary" onclick="checkAzureStatus()">
                                    <i class="fas fa-check-circle me-1"></i>Verifica
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-3x text-info mb-3"></i>
                                <h5>Dashboard Utente</h5>
                                <p class="text-muted">Vai alla dashboard normale</p>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-info">
                                    <i class="fas fa-user me-1"></i>Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-sync-alt fa-3x text-warning mb-3"></i>
                                <h5>Aggiorna Dati</h5>
                                <p class="text-muted">Ricarica statistiche</p>
                                <button class="btn btn-warning" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-1"></i>Aggiorna
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Container per notifiche dinamiche -->
    <div id="alertContainer" class="position-fixed" style="top: 20px; right: 20px; z-index: 9999;"></div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none position-fixed w-100 h-100" style="top: 0; left: 0; background: rgba(0,0,0,0.5); z-index: 10000;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <h4>Caricamento dati...</h4>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// Dati globali
let allData = {
    users: {},
    testResults: [],
    filteredData: []
};

// Chart instances
let timelineChart = null;
let monthlyTrendsChart = null;
let userProgressChart = null;

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
    populateFilters();
});

// NUOVA FUNZIONE per andare all'utente
function goToUser() {
    const email = document.getElementById('searchUserEmail').value.trim();
    if (email) {
        window.location.href = `/admin/user/${encodeURIComponent(email)}`;
    } else {
        alert('Inserisci un\'email valida');
    }
}

// Permetti invio con Enter
document.getElementById('searchUserEmail').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        goToUser();
    }
});

// Carica dati iniziali
async function loadInitialData() {
    showLoading(true);
    try {
        // Carica dati dal server (usando i dati passati dal template)
        allData.users = {{ stats_per_azienda|tojson if stats_per_azienda else '{}' }};
        allData.testResults = {{ recent_tests|tojson if recent_tests else '[]' }};
        allData.filteredData = allData.testResults;
        
        // Popola la vista iniziale
        updateOverviewView();
        
    } catch (error) {
        console.error('Errore caricamento dati:', error);
        showAlert('Errore nel caricamento dei dati', 'danger');
    } finally {
        showLoading(false);
    }
}

// Popola tutti i filtri dinamicamente
function populateFilters() {
    populateTestFilters();
    populateUserFilters();
}

// Popola filtri test dinamicamente
function populateTestFilters() {
    const testFilter = document.getElementById('filterTest');
    const uniqueTests = [...new Set(allData.testResults.map(test => test.test_name))];
    
    uniqueTests.forEach(testName => {
        if (testName) {
            const option = document.createElement('option');
            option.value = testName;
            option.textContent = testName;
            testFilter.appendChild(option);
        }
    });
}

// Popola filtri utenti dinamicamente
function populateUserFilters() {
    const userFilter = document.getElementById('filterUser');
    const uniqueUsers = [...new Set(allData.testResults.map(test => test.user_email))];
    
    uniqueUsers.forEach(email => {
        if (email) {
            const option = document.createElement('option');
            option.value = email;
            // Estrai nome dall'email
            const name = extractNameFromEmail(email);
            option.textContent = `${name} (${email})`;
            userFilter.appendChild(option);
        }
    });
}

// Estrai nome dall'email
function extractNameFromEmail(email) {
    if (email.startsWith('admin@')) {
        return "Admin Sistema";
    }
    
    const localPart = email.split('@')[0];
    const parts = localPart.split('.');
    if (parts.length >= 2) {
        return `${parts[0].charAt(0).toUpperCase() + parts[0].slice(1)} ${parts[1].charAt(0).toUpperCase() + parts[1].slice(1)}`;
    }
    return "User Unknown";
}

// Applica filtri
function applyFilters() {
    const azienda = document.getElementById('filterAzienda').value;
    const test = document.getElementById('filterTest').value;
    const user = document.getElementById('filterUser').value;
    const periodo = document.getElementById('filterPeriodo').value;
    
    let filtered = allData.testResults;
    
    // Filtro azienda
    if (azienda) {
        filtered = filtered.filter(item => item.azienda === azienda);
    }
    
    // Filtro test
    if (test) {
        filtered = filtered.filter(item => item.test_name === test);
    }
    
    // Filtro utente
    if (user) {
        filtered = filtered.filter(item => item.user_email === user);
    }
    
    // Filtro periodo
    if (periodo) {
        const daysAgo = parseInt(periodo);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
        
        filtered = filtered.filter(item => {
            if (item.completed_at) {
                const testDate = new Date(item.completed_at);
                return testDate >= cutoffDate;
            }
            return false;
        });
    }
    
    allData.filteredData = filtered;
    updateCurrentView();
}

// Cambia vista
function changeView() {
    const vista = document.getElementById('filterVista').value;
    
    // Nascondi tutte le viste
    document.querySelectorAll('.dashboard-view').forEach(view => {
        view.classList.add('d-none');
    });
    
    // Mostra vista selezionata
    const targetView = document.getElementById('view' + capitalizeFirst(vista.replace('-', '')));
    if (targetView) {
        targetView.classList.remove('d-none');
    }
    
    // Aggiorna contenuto della vista
    updateCurrentView();
}

// Aggiorna vista corrente
function updateCurrentView() {
    const vista = document.getElementById('filterVista').value;
    
    switch(vista) {
        case 'overview':
            updateOverviewView();
            break;
        case 'by-company':
            updateCompanyView();
            break;
        case 'by-test':
            updateTestView();
            break;
        case 'timeline':
            updateTimelineView();
            break;
        case 'performance':
            updatePerformanceView();
            break;
        case 'user-detail':
            updateUserDetailView();
            break;
    }
    
    updateStatsOverview();
}

// Aggiorna statistiche overview
function updateStatsOverview() {
    const data = allData.filteredData;
    
    // Calcola statistiche filtrate
    const uniqueUsers = [...new Set(data.map(test => test.user_email))].length;
    const totalTests = data.length;
    const scores = data.map(test => test.score || 0).filter(score => score > 0);
    const avgScore = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
    const successRate = scores.length ? ((scores.filter(score => score >= 60).length / scores.length) * 100).toFixed(1) : 0;
    const testsPerUser = uniqueUsers ? (totalTests / uniqueUsers).toFixed(1) : 0;
    
    // Aggiorna DOM
    document.getElementById('totalUsers').textContent = uniqueUsers;
    document.getElementById('totalTests').textContent = totalTests;
    document.getElementById('avgScore').textContent = avgScore + '%';
    document.getElementById('successRate').textContent = successRate + '%';
    document.getElementById('testsPerUser').textContent = testsPerUser;
}

// Vista Overview
function updateOverviewView() {
    updateCompanyStatsTable();
    updateRecentTestsList();
}

// Aggiorna tabella statistiche aziende
function updateCompanyStatsTable() {
    const container = document.getElementById('companyStatsTable');
    const data = allData.filteredData;
    
    // Raggruppa per azienda
    const byCompany = {};
    data.forEach(test => {
        const company = test.azienda || 'Unknown';
        if (!byCompany[company]) {
            byCompany[company] = {
                tests: 0,
                users: new Set(),
                scores: []
            };
        }
        byCompany[company].tests++;
        byCompany[company].users.add(test.user_email);
        if (test.score) byCompany[company].scores.push(test.score);
    });
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Azienda</th>
                        <th class="text-center">Utenti</th>
                        <th class="text-center">Test</th>
                        <th class="text-center">Punteggio Medio</th>
                        <th class="text-center">Tasso Successo</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.entries(byCompany).forEach(([company, stats]) => {
        const avgScore = stats.scores.length ? (stats.scores.reduce((a, b) => a + b, 0) / stats.scores.length).toFixed(1) : 0;
        const successRate = stats.scores.length ? ((stats.scores.filter(s => s >= 60).length / stats.scores.length) * 100).toFixed(1) : 0;
        
        const badgeColor = company === 'auxiell' ? '#6C757D' : 
                          company === 'euxilia' ? '#4A90C2' : 
                          company === 'xva' ? '#D4AF37' : '#6C757D';
        
        html += `
            <tr>
                <td><span class="badge" style="background-color: ${badgeColor}">${company}</span></td>
                <td class="text-center">${stats.users.size}</td>
                <td class="text-center">${stats.tests}</td>
                <td class="text-center">
                    <span class="badge ${avgScore >= 80 ? 'bg-success' : avgScore >= 60 ? 'bg-warning' : 'bg-danger'}">${avgScore}%</span>
                </td>
                <td class="text-center">
                    <span class="badge ${successRate >= 80 ? 'bg-success' : successRate >= 60 ? 'bg-warning' : 'bg-danger'}">${successRate}%</span>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

// Aggiorna lista test recenti
function updateRecentTestsList() {
    const container = document.getElementById('recentTestsList');
    const data = allData.filteredData.slice(0, 10); // Solo ultimi 10
    
    if (data.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <p class="text-muted">Nessun test trovato</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    data.forEach(test => {
        const score = test.score || 0;
        const badgeClass = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
        const date = test.completed_at ? test.completed_at.split('T')[0] : 'N/A';
        const userName = test.user_name || extractNameFromEmail(test.user_email || '');
        
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="/admin/user/${test.user_email}" class="text-decoration-none">
                                ${userName}
                            </a>
                        </h6>
                        <p class="mb-1 small">${test.test_name || 'Test Sconosciuto'}</p>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>${date}
                            <span class="ms-2">
                                <i class="fas fa-building me-1"></i>${test.azienda || 'N/A'}
                            </span>
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${badgeClass} fs-6">${score}%</span>
                        <br>
                        <small class="text-muted">${test.correct_answers || 0}/${test.total_questions || 0}</small>
                        <br>
                        <div class="btn-group btn-group-sm mt-1" role="group">
                            <a href="/admin/user/${test.user_email}" 
                               class="btn btn-outline-primary btn-sm"
                               title="Vedi utente">
                                <i class="fas fa-user"></i>
                            </a>
                            <a href="/admin/download_user_test/${test.user_email}/${test.test_name}" 
                               class="btn btn-outline-success btn-sm"
                               title="Scarica test">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Vista per azienda
function updateCompanyView() {
    const container = document.getElementById('companyDetailedAnalysis');
    const data = allData.filteredData;
    
    // Raggruppa per azienda
    const byCompany = {};
    data.forEach(test => {
        const company = test.azienda || 'Unknown';
        if (!byCompany[company]) {
            byCompany[company] = {
                tests: [],
                users: new Set(),
                testTypes: new Set()
            };
        }
        byCompany[company].tests.push(test);
        byCompany[company].users.add(test.user_email);
        byCompany[company].testTypes.add(test.test_name);
    });
    
    let html = '<div class="row">';
    
    Object.entries(byCompany).forEach(([company, stats]) => {
        const scores = stats.tests.map(t => t.score || 0).filter(s => s > 0);
        const avgScore = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
        const successRate = scores.length ? ((scores.filter(s => s >= 60).length / scores.length) * 100).toFixed(1) : 0;
        
        const badgeColor = company === 'auxiell' ? '#6C757D' : 
                          company === 'euxilia' ? '#4A90C2' : 
                          company === 'xva' ? '#D4AF37' : '#6C757D';
        
        html += `
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header" style="background-color: ${badgeColor}; color: white;">
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            ${company}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary">${stats.users.size}</h4>
                                    <small class="text-muted">Utenti Attivi</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">${stats.tests.length}</h4>
                                <small class="text-muted">Test Completati</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Punteggio Medio:</strong>
                                <span class="badge ${avgScore >= 80 ? 'bg-success' : avgScore >= 60 ? 'bg-warning' : 'bg-danger'} float-end">
                                    ${avgScore}%
                                </span>
                            </div>
                            <div class="col-6">
                                <strong>Tasso Successo:</strong>
                                <span class="badge ${successRate >= 80 ? 'bg-success' : successRate >= 60 ? 'bg-warning' : 'bg-danger'} float-end">
                                    ${successRate}%
                                </span>
                            </div>
                        </div>
                        <hr>
                        <div>
                            <strong>Tipi di Test:</strong>
                            <div class="mt-2">
                                ${Array.from(stats.testTypes).map(testType => 
                                    `<span class="badge bg-secondary me-1">${testType}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Aggiorna Top Performers
    updateTopPerformers();
}

// Top performers
function updateTopPerformers() {
    const container = document.getElementById('topPerformers');
    const data = allData.filteredData;
    
    // Raggruppa per utente
    const byUser = {};
    data.forEach(test => {
        const email = test.user_email;
        if (!byUser[email]) {
            byUser[email] = {
                name: extractNameFromEmail(email),
                azienda: test.azienda,
                tests: [],
                totalScore: 0,
                avgScore: 0
            };
        }
        byUser[email].tests.push(test);
        byUser[email].totalScore += (test.score || 0);
    });
    
    // Calcola medie e ordina
    const performers = Object.values(byUser).map(user => {
        user.avgScore = user.tests.length ? (user.totalScore / user.tests.length) : 0;
        return user;
    }).sort((a, b) => b.avgScore - a.avgScore).slice(0, 5);
    
    let html = '<div class="list-group list-group-flush">';
    
    performers.forEach((user, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
        const badgeClass = user.avgScore >= 80 ? 'success' : user.avgScore >= 60 ? 'warning' : 'danger';
        
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="me-2">${medal}</span>
                        <strong>${user.name}</strong>
                        <br>
                        <small class="text-muted">
                            ${user.azienda} ‚Ä¢ ${user.tests.length} test
                        </small>
                    </div>
                    <span class="badge bg-${badgeClass} fs-6">
                        ${user.avgScore.toFixed(1)}%
                    </span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Vista per tipo di test
function updateTestView() {
    const container = document.getElementById('testTypeAnalysis');
    const data = allData.filteredData;
    
    // Raggruppa per tipo di test
    const byTest = {};
    data.forEach(test => {
        const testType = test.test_name || 'Unknown';
        if (!byTest[testType]) {
            byTest[testType] = {
                tests: [],
                users: new Set(),
                companies: new Set()
            };
        }
        byTest[testType].tests.push(test);
        byTest[testType].users.add(test.user_email);
        byTest[testType].companies.add(test.azienda);
    });
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Tipo Test</th>
                        <th class="text-center">Completamenti</th>
                        <th class="text-center">Utenti Unici</th>
                        <th class="text-center">Aziende</th>
                        <th class="text-center">Punteggio Medio</th>
                        <th class="text-center">Difficolt√†</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.entries(byTest).forEach(([testType, stats]) => {
        const scores = stats.tests.map(t => t.score || 0).filter(s => s > 0);
        const avgScore = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
        const difficulty = avgScore >= 80 ? 'Facile' : avgScore >= 60 ? 'Medio' : 'Difficile';
        const difficultyClass = avgScore >= 80 ? 'success' : avgScore >= 60 ? 'warning' : 'danger';
        
        html += `
            <tr>
                <td>
                    <strong>${testType}</strong>
                    <br>
                    <small class="text-muted">
                        ${Math.round((stats.tests.length / stats.users.size) * 10) / 10} tentativi per utente
                    </small>
                </td>
                <td class="text-center">${stats.tests.length}</td>
                <td class="text-center">${stats.users.size}</td>
                <td class="text-center">${stats.companies.size}</td>
                <td class="text-center">
                    <span class="badge ${avgScore >= 80 ? 'bg-success' : avgScore >= 60 ? 'bg-warning' : 'bg-danger'}">
                        ${avgScore}%
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge bg-${difficultyClass}">
                        ${difficulty}
                    </span>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

// Vista timeline con Chart.js
function updateTimelineView() {
    const data = allData.filteredData;
    
    // Raggruppa per data
    const byDate = {};
    data.forEach(test => {
        if (test.completed_at) {
            const date = test.completed_at.split('T')[0];
            if (!byDate[date]) {
                byDate[date] = {
                    count: 0,
                    scores: [],
                    users: new Set()
                };
            }
            byDate[date].count++;
            byDate[date].scores.push(test.score || 0);
            byDate[date].users.add(test.user_email);
        }
    });
    
    // Prepara dati per il grafico
    const sortedDates = Object.keys(byDate).sort();
    const chartData = {
        labels: sortedDates.map(date => new Date(date).toLocaleDateString('it-IT')),
        datasets: [
            {
                label: 'Test Completati',
                data: sortedDates.map(date => byDate[date].count),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                yAxisID: 'y'
            },
            {
                label: 'Punteggio Medio (%)',
                data: sortedDates.map(date => {
                    const scores = byDate[date].scores.filter(s => s > 0);
                    return scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
                }),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1,
                yAxisID: 'y1'
            }
        ]
    };
    
    // Distruggi grafico esistente
    if (timelineChart) {
        timelineChart.destroy();
    }
    
    // Crea nuovo grafico
    const ctx = document.getElementById('timelineChart').getContext('2d');
    timelineChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Data'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Numero Test'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Punteggio Medio (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    min: 0,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: true
                },
                title: {
                    display: true,
                    text: 'Andamento Test nel Tempo'
                }
            }
        }
    });
    
    // Aggiorna grafico mensile
    updateMonthlyTrendsChart();
    updatePeriodComparison();
}

// Grafico tendenze mensili
function updateMonthlyTrendsChart() {
    const data = allData.filteredData;
    
    // Raggruppa per mese
    const byMonth = {};
    data.forEach(test => {
        if (test.completed_at) {
            const date = new Date(test.completed_at);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!byMonth[monthKey]) {
                byMonth[monthKey] = {
                    count: 0,
                    scores: []
                };
            }
            byMonth[monthKey].count++;
            byMonth[monthKey].scores.push(test.score || 0);
        }
    });
    
    const sortedMonths = Object.keys(byMonth).sort();
    const monthlyData = {
        labels: sortedMonths.map(month => {
            const [year, monthNum] = month.split('-');
            return new Date(year, monthNum - 1).toLocaleDateString('it-IT', { year: 'numeric', month: 'short' });
        }),
        datasets: [{
            label: 'Test per Mese',
            data: sortedMonths.map(month => byMonth[month].count),
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    };
    
    // Distruggi grafico esistente
    if (monthlyTrendsChart) {
        monthlyTrendsChart.destroy();
    }
    
    // Crea nuovo grafico
    const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
    monthlyTrendsChart = new Chart(ctx, {
        type: 'bar',
        data: monthlyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Test Completati per Mese'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Numero Test'
                    }
                }
            }
        }
    });
}

// Confronto periodi
function updatePeriodComparison() {
    const container = document.getElementById('periodComparison');
    const data = allData.filteredData;
    
    const now = new Date();
    const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const lastMonth = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    const thisWeek = data.filter(test => {
        if (test.completed_at) {
            const testDate = new Date(test.completed_at);
            return testDate >= lastWeek;
        }
        return false;
    });
    
    const thisMonth = data.filter(test => {
        if (test.completed_at) {
            const testDate = new Date(test.completed_at);
            return testDate >= lastMonth;
        }
        return false;
    });
    
    const weekAvg = thisWeek.length ? (thisWeek.reduce((sum, test) => sum + (test.score || 0), 0) / thisWeek.length).toFixed(1) : 0;
    const monthAvg = thisMonth.length ? (thisMonth.reduce((sum, test) => sum + (test.score || 0), 0) / thisMonth.length).toFixed(1) : 0;
    
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h4 class="text-primary">${thisWeek.length}</h4>
                        <p class="mb-1">Test Ultima Settimana</p>
                        <small class="text-muted">Media: ${weekAvg}%</small>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h4 class="text-success">${thisMonth.length}</h4>
                        <p class="mb-1">Test Ultimo Mese</p>
                        <small class="text-muted">Media: ${monthAvg}%</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3 text-center">
            <div class="alert alert-info">
                <strong>Trend:</strong> 
                ${thisWeek.length > thisMonth.length / 4 ? 
                    '<i class="fas fa-arrow-up text-success"></i> In crescita' : 
                    '<i class="fas fa-arrow-down text-warning"></i> In calo'}
            </div>
        </div>
    `;
}

// Vista performance
function updatePerformanceView() {
    const container = document.getElementById('performanceAnalysis');
    const rankingContainer = document.getElementById('rankingList');
    const data = allData.filteredData;
    
    // Analisi performance dettagliata
    const scores = data.map(test => test.score || 0).filter(s => s > 0);
    const stats = {
        total: scores.length,
        excellent: scores.filter(s => s >= 90).length,
        good: scores.filter(s => s >= 80 && s < 90).length,
        satisfactory: scores.filter(s => s >= 60 && s < 80).length,
        needsImprovement: scores.filter(s => s < 60).length,
        average: scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0
    };
    
    let performanceHtml = `
        <div class="row">
            <div class="col-md-6">
                <h5>Distribuzione Performance</h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Eccellente (90-100%)</span>
                        <span class="badge bg-success">${stats.excellent}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${stats.total > 0 ? (stats.excellent / stats.total * 100) : 0}%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Buono (80-89%)</span>
                        <span class="badge bg-info">${stats.good}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: ${stats.total > 0 ? (stats.good / stats.total * 100) : 0}%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Sufficiente (60-79%)</span>
                        <span class="badge bg-warning">${stats.satisfactory}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-warning" style="width: ${stats.total > 0 ? (stats.satisfactory / stats.total * 100) : 0}%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Da Migliorare (&lt;60%)</span>
                        <span class="badge bg-danger">${stats.needsImprovement}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-danger" style="width: ${stats.total > 0 ? (stats.needsImprovement / stats.total * 100) : 0}%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5>Metriche Chiave</h5>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="card bg-primary text-white mb-3">
                            <div class="card-body">
                                <h3>${stats.average}%</h3>
                                <small>Punteggio Medio</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-success text-white mb-3">
                            <div class="card-body">
                                <h3>${stats.total > 0 ? ((stats.excellent + stats.good) / stats.total * 100).toFixed(1) : 0}%</h3>
                                <small>Performance Ottima</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-warning text-white mb-3">
                            <div class="card-body">
                                <h3>${stats.total > 0 ? (stats.satisfactory / stats.total * 100).toFixed(1) : 0}%</h3>
                                <small>Performance Media</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-danger text-white mb-3">
                            <div class="card-body">
                                <h3>${stats.total > 0 ? (stats.needsImprovement / stats.total * 100).toFixed(1) : 0}%</h3>
                                <small>Necessita Supporto</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = performanceHtml;
    
    // Ranking completo
    const byUser = {};
    data.forEach(test => {
        const email = test.user_email;
        if (!byUser[email]) {
            byUser[email] = {
                name: extractNameFromEmail(email),
                azienda: test.azienda,
                tests: [],
                totalScore: 0,
                avgScore: 0
            };
        }
        byUser[email].tests.push(test);
        byUser[email].totalScore += (test.score || 0);
    });
    
    const ranking = Object.values(byUser).map(user => {
        user.avgScore = user.tests.length ? (user.totalScore / user.tests.length) : 0;
        return user;
    }).sort((a, b) => b.avgScore - a.avgScore);
    
    let rankingHtml = `
        <div style="max-height: 500px; overflow-y: auto;">
            <h5>Ranking Completo</h5>
    `;
    
    ranking.forEach((user, index) => {
        const badgeClass = user.avgScore >= 80 ? 'success' : user.avgScore >= 60 ? 'warning' : 'danger';
        const position = index + 1;
        const medal = position <= 3 ? (position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : 'ü•â') : `#${position}`;
        
        rankingHtml += `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div class="d-flex align-items-center">
                    <span class="me-3" style="min-width: 40px;">${medal}</span>
                    <div>
                        <strong>${user.name}</strong>
                        <br>
                        <small class="text-muted">${user.azienda} ‚Ä¢ ${user.tests.length} test</small>
                    </div>
                </div>
                <span class="badge bg-${badgeClass} fs-6">
                    ${user.avgScore.toFixed(1)}%
                </span>
            </div>
        `;
    });
    
    rankingHtml += '</div>';
    rankingContainer.innerHTML = rankingHtml;
}

// Vista dettaglio utente
function updateUserDetailView() {
    const selectedUser = document.getElementById('filterUser').value;
    const userNameElement = document.getElementById('selectedUserName');
    const contentContainer = document.getElementById('userDetailContent');
    const statsContainer = document.getElementById('userStats');
    
    if (!selectedUser) {
        userNameElement.textContent = '- Seleziona un utente dal filtro';
        contentContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-user-plus fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Seleziona un utente specifico dal filtro per vedere i dettagli</h5>
                <p class="text-muted">Utilizza il filtro "Utente Specifico" per visualizzare i risultati di un singolo utente</p>
            </div>
        `;
        statsContainer.innerHTML = '';
        return;
    }
    
    const userName = extractNameFromEmail(selectedUser);
    userNameElement.textContent = `- ${userName}`;
    
    // Filtra dati per l'utente selezionato
    const userData = allData.testResults.filter(test => test.user_email === selectedUser);
    
    if (userData.length === 0) {
        contentContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
                <h5 class="text-warning">Nessun test trovato per questo utente</h5>
            </div>
        `;
        return;
    }
    
    // Ordina per data
    userData.sort((a, b) => new Date(b.completed_at || 0) - new Date(a.completed_at || 0));
    
    // Costruisci tabella dettagliata
    let detailHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Test</th>
                        <th class="text-center">Punteggio</th>
                        <th class="text-center">Risposte Corrette</th>
                        <th class="text-center">Stato</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    userData.forEach(test => {
        const date = test.completed_at ? new Date(test.completed_at).toLocaleDateString('it-IT') : 'N/A';
        const score = test.score || 0;
        const badgeClass = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
        const status = score >= 60 ? 'Superato' : 'Non Superato';
        const statusClass = score >= 60 ? 'text-success' : 'text-danger';
        
        detailHtml += `
            <tr>
                <td>${date}</td>
                <td>${test.test_name || 'N/A'}</td>
                <td class="text-center">
                    <span class="badge bg-${badgeClass} fs-6">${score}%</span>
                </td>
                <td class="text-center">${test.correct_answers || 0}/${test.total_questions || 0}</td>
                <td class="text-center">
                    <span class="${statusClass}"><strong>${status}</strong></span>
                </td>
                <td class="text-center">
                    <a href="/admin/download_user_test/${selectedUser}/${test.test_name}" 
                       class="btn btn-sm btn-outline-success"
                       title="Scarica questo test">
                        <i class="fas fa-download"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    detailHtml += `</tbody></table></div>`;
    contentContainer.innerHTML = detailHtml;
    
    // Statistiche utente
    const scores = userData.map(test => test.score || 0).filter(s => s > 0);
    const avgScore = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
    const bestScore = scores.length ? Math.max(...scores) : 0;
    const worstScore = scores.length ? Math.min(...scores) : 0;
    const passedTests = scores.filter(s => s >= 60).length;
    const totalTests = userData.length;
    
    statsContainer.innerHTML = `
        <div class="row text-center mb-3">
            <div class="col-6">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h4>${totalTests}</h4>
                        <small>Test Totali</small>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h4>${passedTests}</h4>
                        <small>Test Superati</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="row text-center">
            <div class="col-4">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5>${avgScore}%</h5>
                        <small>Media</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5>${bestScore}%</h5>
                        <small>Migliore</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <h5>${worstScore}%</h5>
                        <small>Peggiore</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <div class="progress">
                <div class="progress-bar bg-success" style="width: ${totalTests > 0 ? (passedTests / totalTests * 100) : 0}%">
                    ${totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0}% Successo
                </div>
            </div>
        </div>
    `;
    
    // Aggiorna grafico progresso utente
    updateUserProgressChart(userData);
}

// Grafico progresso utente
function updateUserProgressChart(userData) {
    const sortedData = userData.sort((a, b) => new Date(a.completed_at || 0) - new Date(b.completed_at || 0));
    
    const chartData = {
        labels: sortedData.map((test, index) => `Test ${index + 1}`),
        datasets: [{
            label: 'Punteggio (%)',
            data: sortedData.map(test => test.score || 0),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
        }]
    };
    
    // Distruggi grafico esistente
    if (userProgressChart) {
        userProgressChart.destroy();
    }
    
    // Crea nuovo grafico
    const ctx = document.getElementById('userProgressChart').getContext('2d');
    userProgressChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Progresso nel Tempo'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Punteggio (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Test Cronologico'
                    }
                }
            },
            elements: {
                point: {
                    radius: 6,
                    hoverRadius: 8
                }
            }
        }
    });
}

// Funzioni utility
function capitalizeFirst(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
        overlay.classList.remove('d-none');
    } else {
        overlay.classList.add('d-none');
    }
}

// Verifica stato Azure
async function checkAzureStatus() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verificando...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/admin/azure-status');
        const data = await response.json();
        
        if (data.status === 'healthy') {
            showAlert(`
                <strong>Azure Status: OK</strong><br>
                <small>Utenti: ${data.record_counts?.users || 0} | Risultati: ${data.record_counts?.results || 0}</small>
            `, 'success');
        } else {
            showAlert(`<strong>Azure Status: Errore</strong><br>${data.error || 'Stato sconosciuto'}`, 'warning');
        }
    } catch (error) {
        showAlert(`<strong>Errore verifica Azure:</strong><br>${error.message}`, 'danger');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Aggiorna dati
async function refreshData() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Aggiornando...';
    btn.disabled = true;
    
    try {
        showLoading(true);
        
        // Ricarica la pagina per ottenere dati freschi
        setTimeout(() => {
            location.reload();
        }, 1000);
        
        showAlert('Dati aggiornati con successo!', 'success');
        
    } catch (error) {
        showAlert(`<strong>Errore aggiornamento:</strong><br>${error.message}`, 'danger');
        btn.innerHTML = originalText;
        btn.disabled = false;
        showLoading(false);
    }
}

// Funzione per mostrare alert dinamici
function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();
    
    const alertDiv = document.createElement('div');
    alertDiv.id = alertId;
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-2`;
    alertDiv.style.cssText = 'min-width: 350px; max-width: 500px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="removeAlert('${alertId}')"></button>
    `;
    
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove dopo 5 secondi
    setTimeout(() => removeAlert(alertId), 5000);
}

// Funzione per rimuovere alert
function removeAlert(alertId) {
    const alert = document.getElementById(alertId);
    if (alert) {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 150);
    }
}

// Event listener per cambio filtro utente
document.addEventListener('DOMContentLoaded', function() {
    const userFilter = document.getElementById('filterUser');
    const vistaFilter = document.getElementById('filterVista');
    
    // Auto-switch alla vista dettaglio utente quando si seleziona un utente
    userFilter.addEventListener('change', function() {
        if (this.value && vistaFilter.value !== 'user-detail') {
            vistaFilter.value = 'user-detail';
            changeView();
        }
    });
    
    // Reset filtro utente quando si cambia vista (eccetto user-detail)
    vistaFilter.addEventListener('change', function() {
        if (this.value !== 'user-detail') {
            userFilter.value = '';
            applyFilters();
        }
    });
    
    // Aggiungi tooltip per i pulsanti
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});

// Cleanup grafici quando si cambia vista
function destroyCharts() {
    if (timelineChart) {
        timelineChart.destroy();
        timelineChart = null;
    }
    if (monthlyTrendsChart) {
        monthlyTrendsChart.destroy();
        monthlyTrendsChart = null;
    }
    if (userProgressChart) {
        userProgressChart.destroy();
        userProgressChart = null;
    }
}

// Override della funzione changeView per gestire cleanup
const originalChangeView = changeView;
changeView = function() {
    const previousVista = document.getElementById('filterVista').value;
    
    // Distruggi grafici se si sta cambiando vista
    if (previousVista === 'timeline' || previousVista === 'user-detail') {
        destroyCharts();
    }
    
    // Chiama la funzione originale
    originalChangeView();
};

</script>

<style>
/* CSS aggiornato per visibilit√† testo */
.card {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    background-color: white !important;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.card-body {
    padding: 1.5rem;
}

.card-title {
    color: #333 !important;
    font-weight: 600;
    font-size: 0.9rem;
}

.card h3 {
    font-weight: bold;
    font-size: 1.8rem;
}

/* Forza i colori del testo per essere visibili */
.text-dark {
    color: #212529 !important;
}

.text-secondary {
    color: #6c757d !important;
}

.dashboard-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.dashboard-card h3 {
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 10px;
    color: #333;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #e9ecef;
}

.list-group-item:last-child {
    border-bottom: none;
}

.timeline-container {
    border-left: 3px solid #007bff;
    padding-left: 20px;
}

.progress {
    height: 10px;
    border-radius: 5px;
}

.badge {
    font-size: 0.85em;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

#alertContainer .alert {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: none;
    border-radius: 8px;
}

.text-gold {
    color: #D4AF37 !important;
}

/* Responsive */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
    
    .dashboard-card {
        padding: 20px;
        margin-bottom: 15px;
    }
    
    .col-md-2 {
        margin-bottom: 15px;
    }
}

/* Loading overlay styling */
#loadingOverlay {
    backdrop-filter: blur(2px);
}

#loadingOverlay .spinner-border {
    border-width: 0.3em;
}

/* Chart containers */
canvas {
    max-height: 400px;
}

/* Custom scrollbar for ranking */
#rankingList::-webkit-scrollbar {
    width: 6px;
}

#rankingList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#rankingList::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

#rankingList::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}
